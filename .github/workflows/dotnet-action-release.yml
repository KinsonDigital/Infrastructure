name: ‚öôÔ∏èPerform DotNet Action Release
run-name: ‚öôÔ∏èPerform ${{ inputs.release-type }} Release (${{ inputs.build-config }} Build)


defaults:
  run:
    shell: pwsh


on:
  workflow_call:
    inputs:
      project-name:
        required: true
        description: "The name of the C# project to validate."
        type: string
      release-type:
        required: true
        description: The type of release to validate.  Either 'Preview' or 'Production'.
        type: string
      net-sdk-version:
        required: true
        description: The version of the .NET SDK to use.
        type: string
      release-notes-file-path:
        required: true
        description: The file path to the release notes file to check for existence.
        type: string
      build-config:
        required: true
        description: The build configuration to use. This is either 'Debug' or 'Release'.
        default: Debug
        type: string
      deno-version:
        required: true
        description: The version of Deno to use.  The deno platform is used in all of the composite actions used in this workflow.
        type: string
      enable-deno-cache:
        required: false
        description: If true, enables caching of the Deno modules.
        default: true
        type: boolean
      runs-on:
        required: false
        description: |
          The type of machine to run the job on.
          The type of machine to run the job on.
          Reference: https://docs.github.com/en/actions/how-tos/write-workflows/choose-where-workflows-run/choose-the-runner-for-a-job#standard-github-hosted-runners-for-public-repositories
        type: string
        default: ubuntu-latest
      dry-run:
        required: false
        description: If true, the release will not be created.
        default: false
        type: boolean
    secrets:
      cicd-pat:
        required: true
        description: The CICD personal access token.


jobs:
  get_and_validate_version:
    name: Get And Validate Version
    runs-on: "${{ inputs.runs-on }}"
    outputs:
      version: ${{ steps.get-version.outputs.version }}
    steps:
      - name: Get Version
        id: get-version
        uses: KinsonDigital/Infrastructure/actions/get-version@main
        with:
          version-file-path: "${{ github.workspace }}/${{ inputs.project-name }}/${{ inputs.project-name }}.csproj"
          deno-version: "${{ vars.DENO_VERSION }}"

      - name: Validate Version
        id: validate-version
        uses: KinsonDigital/Infrastructure/actions/validate-version@main
        with:
          version: "${{ steps.get-version.outputs.version}}"
          release-type: "${{ inputs.release-type }}"
          deno-version: "${{ vars.DENO_VERSION }}"

  run_prerelease_validation:
    name: Run Pre-Release Validation
    needs: [get_and_validate_version]
    runs-on: "${{ inputs.runs-on }}"
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v5

      - name: Set Up Deno (${{ inputs.deno-version }})
        uses: denoland/setup-deno@v2
        with:
          deno-version: ${{ inputs.deno-version }}
          cache: ${{ inputs.enable-deno-cache }}

      - name: Validate Tag
        id: tag-check
        uses: KinsonDigital/Infrastructure/actions/validate-tag@main
        with:
          repo-owner: "${{ vars.ORGANIZATION_NAME }}"
          repo-name: "${{ inputs.project-name }}"
          release-type: "${{ inputs.release-type }}"
          tag-name: "${{ needs.get_and_validate_version.outputs.version }}"
          github-token: "${{ secrets.cicd-pat }}"
          deno-version: "${{ inputs.deno-version }}"
        continue-on-error: true

      - name: Validate SDK Versions
        id: sdk-check
        uses: KinsonDigital/Infrastructure/actions/validate-sdk-versions@main
        with:
          base-search-dir-path: "${{ github.workspace }}"
          net-sdk-version: "${{ vars.NET_SDK_VERSION }}"
          deno-version: "${{ inputs.deno-version }}"
        continue-on-error: true

      - name: Release Notes Exist
        id: release-notes-check
        uses: KinsonDigital/Infrastructure/actions/release-notes-exist@main
        with:
          release-notes-file-path: "${{ inputs.release-notes-file-path }}"
          deno-version: "${{ inputs.deno-version }}"
          fail-if-does-not-exist: true
        continue-on-error: true
        
      - name: Nuget Package Does Not Exist
        uses: KinsonDigital/Infrastructure/actions/nuget-pkg-exists@main
        id: package-check
        with:
          nuget-pkg-name: "${{ vars.ORGANIZATION_NAME }}.${{ inputs.project-name }}"
          nuget-pkg-version: "${{ needs.get_and_validate_version.outputs.version }}"
          deno-version: "${{ inputs.deno-version }}"
        continue-on-error: true

      - name: Milestone Exists
        id: milestone-exists
        uses: KinsonDigital/Infrastructure/actions/milestone-exists@main
        with:
          owner-name: "${{ vars.ORGANIZATION_NAME }}"
          repo-name: "${{ inputs.project-name }}"
          milestone-name: "${{ needs.get_and_validate_version.outputs.version }}"
          github-token: "${{ secrets.cicd-pat }}"
          deno-version: "${{ inputs.deno-version }}"
        continue-on-error: true

      - name: Validate Milestone Items
        id: milestone-items-check
        uses: KinsonDigital/Infrastructure/actions/milestone-items-closed@main
        with:
          owner-name: "${{ vars.ORGANIZATION_NAME }}"
          repo-name: "${{ inputs.project-name }}"
          milestone-name: "${{ needs.get_and_validate_version.outputs.version }}"
          github-token: "${{ secrets.cicd-pat }}"
          deno-version: "${{ inputs.deno-version }}"
          fail-if-all-items-not-closed: true
        continue-on-error: true

      - name: GitHub Release Exists
        id: github-release-check
        uses: KinsonDigital/Infrastructure/actions/github-release-exists@main
        with:
          owner-name: "${{ vars.ORGANIZATION_NAME }}"
          repo-name: "${{ inputs.project-name }}"
          tag-name: "${{ needs.get_and_validate_version.outputs.version }}"
          deno-version: "${{ inputs.deno-version }}"
          github-token: "${{ secrets.CICD_TOKEN }}"
        continue-on-error: true

      - name: Should Fail Job
        run: |
          $tagCheckFailed = "${{ steps.tag-check.outcome == 'failure' }}";
          $sdkCheckFailed = "${{ steps.sdk-check.outcome == 'failure' }}";
          $notesFileCheckFailed = "${{ steps.release-notes-check.outcome == 'failure' }}";
          $packageCheckFailed = "${{ steps.package-check.outcome == 'failure' }}";
          $milestoneExists = "${{ steps.milestone-exists.outputs.milestone-exists }}";
          $milestoneItemsCheckFailed = "${{ steps.milestone-items-check.outcome == 'failure' }}";
          $githubReleaseCheckFailed = "${{ steps.github-release-check.outcome == 'failure' }}";

          if ($tagCheckFailed -eq "true") {
            Write-Host "::error::Tag already exists.  Please update the version in the 'deno.json' file.";
          }

          if ($sdkCheckFailed -eq "true") {
            Write-Host "::error::One or more of the SDK versions are invalid. Check each '.csproj' file.";
          }

          if ($notesFileCheckFailed -eq "true") {
            Write-Host "::error::The release notes for version '${{ needs.get_and_validate_version.outputs.version }}' do not exist.";
          }

          if ($packageCheckFailed -eq "true") {
            Write-Host "::error::The NuGet package already exists.";
          }

          if ($milestoneExists -eq "false") {
            Write-Host "::error::The milestone '${{ needs.get_and_validate_version.outputs.version }}' does not exist.";
          }

          if ($milestoneItemsCheckFailed -eq "true") {
            Write-Host "::error::The milestone '${{ needs.get_and_validate_version.outputs.version }}' has one or more issues that are not closed or prs that are in draft.";
          }

          if ($githubReleaseCheckFailed -eq "true") {
            Write-Host "::error::The GitHub release already exists.";
          }

          if ($tagCheckFailed -eq "true" `
              -or $sdkCheckFailed -eq "true" `
              -or $notesFileCheckFailed -eq "true" `
              -or $packageCheckFailed -eq "true" `
              -or $milestoneExists -eq "false" `
              -or $milestoneItemsCheckFailed -eq "true" `
              -or $githubReleaseCheckFailed -eq "true") {
            exit 1;
          }


  build_project:
    name: Build Main Project (${{ inputs.project-name }})
    needs: run_prerelease_validation
    uses: KinsonDigital/Infrastructure/.github/workflows/build-csharp-project.yml@v15.0.0
    with:
      project-name: "${{ inputs.project-name }}"
      runs-on: "${{ inputs.runs-on }}"
      build-config: "${{ inputs.build-config }}"
      net-sdk-version: "${{ inputs.net-sdk-version }}"
    secrets:
      cicd-pat: ${{ secrets.cicd-pat }}


  perform_release:
    name: Perform ${{ inputs.release-type }} Release
    needs: [
      run_prerelease_validation,
      get_and_validate_version,
      build_project,
    ]
    runs-on: "${{ inputs.runs-on }}"
    steps:
    - name: Checkout
      uses: actions/checkout@v5 

    - name: Create GitHub Release ${{ inputs.dry-run == true && '(Dry Run)' || '' }}
      if: inputs.dry-run == false
      uses: ncipollo/release-action@v1
      with:
        name: "üöÄ${{ inputs.release-type }} - ${{ needs.get_and_validate_version.outputs.version }}"
        tag: ${{ needs.get_and_validate_version.outputs.version }}
        owner: ${{ vars.ORGANIZATION_NAME }}
        repo: ${{ inputs.project-name }}
        bodyFile: "${{ github.workspace }}/ReleaseNotes/${{ inputs.release-type }}Releases/Release-Notes-${{ needs.get_and_validate_version.outputs.version }}.md"
        artifacts: "${{ github.workspace }}/ReleaseNotes/${{ inputs.release-type }}Releases/Release-Notes-${{ needs.get_and_validate_version.outputs.version }}.md"
        prerelease: ${{ inputs.release-type }} == 'Preview'
        token: ${{ secrets.CICD_TOKEN }}
