name: ⚙️Perform DotNet Lib Release
run-name: ⚙️Perform ${{ inputs.release-type }} Release (${{ inputs.build-config }} Build)


defaults:
  run:
    shell: pwsh


on:
  workflow_call:
    inputs:
      project-name:
        required: true
        description: "The name of the C# project to validate."
        type: string
      release-type:
        required: true
        description: The type of release to validate.  Either 'Preview' or 'Production'.
        type: string
      run-branch:
        required: true
        description: The name of the branch to run the workflow.
        type: string
      net-sdk-version:
        required: true
        description: The version of the .NET SDK to use.
        type: string
      relative-release-notes-dir-path:
        required: true
        description: The relative directory path to the release notes.
        type: string
      build-config:
        required: true
        description: The build configuration to use. This is either 'Debug' or 'Release'.
        default: Debug
        type: string
      release-notes-file-name-prefix:
        required: false
        description: The prefix of the release notes file name.  This is what is prefixed before the version number.
        type: string
      runs-on:
        required: false
        description: The type of machine to run the job on.
        type: string
        default: ubuntu-latest
      pr-include-notes-label:
        required: false
        description: The label on a pull request that forces its inclusion in the release notes.
        type: string
        default: ""
      transpile-readme:
        required: false
        description: If true, transpiles the README.md file HTML to markdown.
        default: false
        type: boolean
      send-x-release-post:
        required: false
        description: If true, sends a post about the release to X.
        default: false
        type: boolean
      dry-run:
        required: false
        description: If true, the release will not be created.
        default: false
        type: boolean
    secrets:
      cicd-pat:
        required: true
        description: The CICD personal access token.
      nuget-org-api-key:
        required: true
        description: The NuGet.org API key.
      x-consumer-api-key:
        required: false
        description: The X consumer API key.
      x-consumer-api-secret:
        required: false
        description: The X consumer API secret.
      x-access-token-key:
        required: false
        description: The X access token key.
      x-access-token-secret:
        required: false
        description: The X access token secret.


env:
  OWNER_NAME: "${{ vars.ORGANIZATION_NAME }}"
  REPO_NAME: "${{ inputs.project-name }}"


jobs:
  get_and_validate_version:
    name: Get And Validate Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.validate-version.outputs.version }}
    steps:
      - name: Get Version
        id: get-version
        uses: KinsonDigital/Infrastructure/actions/get-version@feature/269-create-custom-actions
        with:
          version-file-path: "${{ github.workspace }}/${{ inputs.project-name }}/${{ inputs.project-name }}.csproj"
          github-token: "${{ secrets.cicd-pat }}"
          deno-version: "${{ vars.DENO_VERSION }}"
          action-version: "${{ vars.CICD_SCRIPTS_VERSION }}"

      - name: Validate Version
        id: validate-version
        uses: KinsonDigital/Infrastructure/actions/validate-version@feature/269-create-custom-actions
        with:
          version: "${{ steps.get-version.outputs.version}}"
          release-type: "${{ inputs.release-type }}"
          deno-version: "${{ vars.DENO_VERSION }}"
          action-version: "${{ vars.CICD_SCRIPTS_VERSION }}"


  run_prerelease_validation:
    name: Run Pre-Release Validation
    needs: [get_and_validate_version]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set Up Deno (${{ vars.DENO_VERSION }})
        uses: denoland/setup-deno@v2
        with:
          deno-version: ${{ vars.DENO_VERSION }}

      - name: Validate Branch
        id: branch-check
        continue-on-error: true
        run: |
          $branch = "${{ github.ref_name }}"

          if ($branch -ne "${{ inputs.run-branch }}") {
            Write-Host "::error::The branch '$branch' is invalid. This release can only run on '${{ inputs.run-branch }}' branches."
            exit 1;
          }

      - name: Build Script Base URL
        id: build-script-base-url
        run: |
          # Construct the URL to the organizations CICD scripts
          $scriptUrl = "${{ vars.SCRIPT_BASE_URL }}/${{ vars.CICD_SCRIPTS_VERSION }}/${{ vars.SCRIPT_RELATIVE_DIR_PATH }}";
          $scriptUrl = $scriptUrl.Replace("\", "/").Replace("//", "/");
          $scriptUrl = $scriptUrl.EndsWith("/") ? $scriptUrl.Substring(0, $scriptUrl.Length - 1) : $scriptUrl;

          Write-Host "::notice::Script Base URL: $scriptUrl";

          "url=$scriptUrl" >> $env:GITHUB_OUTPUT;

      - name: Validate Tag
        id: tag-check
        continue-on-error: true
        env:
          RELEASE_TYPE: "${{ inputs.release-type }}"
          TAG_NAME: "${{ needs.get_and_validate_version.outputs.version }}"
          GITHUB_TOKEN: "${{ secrets.cicd-pat }}"
        run: |
          $scriptUrl = "${{ steps.build-script-base-url.outputs.url }}/validate-tag.ts";

          Write-Host "::notice::Validate Tag Script URL: $scriptUrl";

          deno run -ERNS "$scriptUrl";

      - name: Validate SDK Versions
        id: sdk-check
        continue-on-error: true
        env:
          BASE_SEARCH_DIR_PATH: "${{ github.workspace }}"
          NET_SDK_VERSION: "${{ vars.NET_SDK_VERSION }}"
        run: |
          $scriptUrl = "${{ steps.build-script-base-url.outputs.url }}/validate-sdk-versions.ts";

          deno run -ER "$scriptUrl";

      - name: Release Notes Exist
        id: release-notes-check
        continue-on-error: true
        env:
          RELATIVE_RELEASE_NOTES_DIR_PATH: "${{ inputs.relative-release-notes-dir-path }}"
          RELEASE_TYPE: "${{ inputs.release-type }}"
          TAG_NAME: "${{ needs.get_and_validate_version.outputs.version }}"
        run: |
          $scriptUrl = "${{ steps.build-script-base-url.outputs.url }}/release-notes-exist.ts";

          deno run -ER "$scriptUrl";

      - name: Package Does Not Exist
        id: package-check
        continue-on-error: true
        env:
          NUGET_PKG_NAME: "${{ vars.ORGANIZATION_NAME }}.${{ inputs.project-name }}"
          NUGET_PKG_VERSION: "${{ needs.get_and_validate_version.outputs.version }}"
        run: |
          $scriptUrl = "${{ steps.build-script-base-url.outputs.url }}/nuget-pkg-does-not-exist.ts";

          deno run -ERN "$scriptUrl";

      - name: Milestone Exists
        id: milestone-exists-check
        continue-on-error: true
        env:
          MILESTONE_TITLE: "${{ needs.get_and_validate_version.outputs.version }}"
          GITHUB_TOKEN: ${{ secrets.cicd-pat }}
        run: |
          $scriptUrl = "${{ steps.build-script-base-url.outputs.url }}/milestone-exists.ts";

          deno run -ERNS "$scriptUrl";

      - name: Validate Milestone
        id: milestone-check
        env:
          MILESTONE_TITLE: "${{ needs.get_and_validate_version.outputs.version }}"
          GITHUB_TOKEN: "${{ secrets.cicd-pat }}"
        continue-on-error: true
        run: |
          $scriptUrl = "${{ steps.build-script-base-url.outputs.url }}/milestone-items-all-closed.ts";

          deno run -ERN "$scriptUrl";

      - name: GitHub Release Does Not Exist 
        id: github-release-check
        continue-on-error: true
        env:
          TAG_NAME: "${{ needs.get_and_validate_version.outputs.version }}"
          GITHUB_TOKEN: "${{ secrets.cicd-pat }}"
        run: |
          $scriptUrl = "${{ steps.build-script-base-url.outputs.url }}/github-release-does-not-exist.ts";

          Write-Host "::notice::Validate GitHub Release Version Script URL: $scriptUrl";

          deno run -ERN "$scriptUrl";
    
      - name: Should Fail Job
        run: |
          $branchCheckFailed = "${{ steps.branch-check.outcome == 'failure' }}";
          $tagCheckFailed = "${{ steps.tag-check.outcome == 'failure' }}";
          $sdkCheckFailed = "${{ steps.sdk-check.outcome == 'failure' }}";
          $notesFileCheckFailed = "${{ steps.release-notes-check.outcome == 'failure' }}";
          $packageCheckFailed = "${{ steps.package-check.outcome == 'failure' }}";
          $milestoneExistsCheckFailed = "${{ steps.milestone-exists-check.outcome == 'failure' }}";
          $milestoneCheckFailed = "${{ steps.milestone-check.outcome == 'failure' }}";
          $githubReleaseCheckFailed = "${{ steps.github-release-check.outcome == 'failure' }}";

          if ($branchCheckFailed -eq "true") {
            Write-Host "::error::The branch is invalid.  Check the 'run-branch' workflow input.";
          }

          if ($tagCheckFailed -eq "true") {
            Write-Host "::error::Tag already exists.  Please update the version in the 'deno.json' file.";
          }

          if ($sdkCheckFailed -eq "true") {
            Write-Host "::error::One or more of the SDK versions are invalid. Check each '.csproj' file.";
          }

          if ($notesFileCheckFailed -eq "true") {
            Write-Host "::error::The release notes for version '${{ needs.get_and_validate_version.outputs.version }}' do not exist.";
          }

          if ($packageCheckFailed -eq "true") {
            Write-Host "::error::The NuGet package already exists.";
          }

          if ($milestoneExistsCheckFailed -eq "true") {
            Write-Host "::error::The milestone '${{ needs.get_and_validate_version.outputs.version }}' does not exist.";
          }

          if ($milestoneCheckFailed -eq "true") {
            Write-Host "::error::The milestone '${{ needs.get_and_validate_version.outputs.version }}' has one or more issues that are not closed.";
          }

          if ($githubReleaseCheckFailed -eq "true") {
            Write-Host "::error::The GitHub release already exists.";
          }

          if ($branchCheckFailed -eq "true" `
              -or $tagCheckFailed -eq "true" `
              -or $sdkCheckFailed -eq "true" `
              -or $notesFileCheckFailed -eq "true" `
              -or $packageCheckFailed -eq "true" `
              -or $milestoneExistsCheckFailed -eq "true" `
              -or $milestoneCheckFailed -eq "true" `
              -or $githubReleaseCheckFailed -eq "true") {
            exit 1;
          }


  build_project:
    name: Build Main Project
    needs: [run_prerelease_validation]
    uses: KinsonDigital/Infrastructure/.github/workflows/build-csharp-project.yml@v15.0.0
    with:
      project-name: "${{ inputs.project-name }}"
      runs-on: "${{ inputs.runs-on }}"
      build-config: "${{ inputs.build-config }}"
      net-sdk-version: "${{ inputs.net-sdk-version }}"
    secrets:
      cicd-pat: ${{ secrets.cicd-pat }}


  run_tests:
    name: Run Tests
    needs: [run_prerelease_validation]
    uses: KinsonDigital/Infrastructure/.github/workflows/run-csharp-tests.yml@v15.0.0
    with:
      project-name: "${{ inputs.project-name }}Tests"
      runs-on: "${{ inputs.runs-on }}"
      build-config: "${{ inputs.build-config }}"
      net-sdk-version: "${{ inputs.net-sdk-version }}"
    secrets:
      cicd-pat: ${{ secrets.cicd-pat }}


  perform_release:
    name: Perform ${{ inputs.release-type }} Release
    runs-on: ubuntu-latest
    needs: [run_prerelease_validation, get_and_validate_version,
      build_project, run_tests]
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set Up .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "${{ inputs.net-sdk-version }}"

      - name: Set Up Nuget
        uses: NuGet/setup-nuget@v2

      - name: Set Up Deno (${{ vars.DENO_VERSION }})
        uses: denoland/setup-deno@v2
        with:
          deno-version: ${{ vars.DENO_VERSION }}

      - name: Create Script URL
        id: script-url
        run: |
          # Construct the URL to the organizations CICD scripts
          $url = "${{ vars.SCRIPT_BASE_URL }}/${{ vars.CICD_SCRIPTS_VERSION }}/${{ vars.SCRIPT_RELATIVE_DIR_PATH }}";
          $url = $url.Replace("\", "/").Replace("//", "/");
          $url = $url.EndsWith("/") ? $url.Substring(0, $url.Length - 1) : $url;
          
          Write-Host "::notice::DotNet Lib Release Script URL: $url";
          "url=$url" >> "$env:GITHUB_OUTPUT";

      - name: Transpile README
        if: inputs.transpile-readme == true
        uses: KinsonDigital/Infrastructure/actions/transpile-readme@feature/269-create-custom-actions
        with:
          base-dir-path: "${{ github.workspace }}"
          deno-version: "${{ vars.DENO_VERSION }}"
          action-version: "${{ vars.CICD_SCRIPTS_VERSION }}"

      - name: Update Copyright
        env:
          CS_PROJ_FILE_NAME: "${{ inputs.project-name }}.csproj"
        run: deno run -ERW "${{ steps.script-url.outputs.url }}/update-copyright.ts";

      - name: Create Nuget Package
        run: |
          dotnet pack `
            "${{ github.workspace }}/${{ inputs.project-name }}/${{ inputs.project-name }}.csproj" `
            -o "${{ github.workspace }}" `
            -c ${{ inputs.build-config }} `
            -p:IncludeSymbols=true `
            -p:SymbolPackageFormat=snupkg;

      - name: Publish Nuget Package
        if: ${{ inputs.dry-run == false }}
        run: |
          $version = "${{ needs.get_and_validate_version.outputs.version }}";
          $version = $version.StartsWith("v") ? $version.Substring(1) : $version;

          # Push the nuget package
          dotnet nuget push `
            "${{ github.workspace }}/${{ vars.ORGANIZATION_NAME }}.${{ inputs.project-name }}.$version.nupkg" `
            --api-key ${{ secrets.nuget-org-api-key }} `
            --source https://api.nuget.org/v3/index.json;

      - name: Send X Release Announcement
        uses: KinsonDigital/Infrastructure/actions/send-x-release-announcement@main
        with:
          repo_owner: "${{ vars.ORGANIZATION_NAME }}"
          repo_name: "${{ inputs.project-name }}"
          github-token: "${{ secrets.cicd-pat }}"
          release-x-post-template-repo-name: "${{ vars.RELEASE_X_POST_TEMPLATE_REPO_NAME }}"
          release-x-post-template-branch-name: "${{ vars.RELEASE_X_POST_TEMPLATE_BRANCH_NAME }}"
          relative-release-x-post-template-file-path: "${{ vars.RELATIVE_RELEASE_X_POST_TEMPLATE_FILE_PATH }}"
          discord-invite-code: "${{ vars.DISCORD_INVITE_CODE }}"
          x-broadcast-enabled: "${{ vars.X_BROADCAST_ENABLED }}"
          x-access-token-key: "${{ secrets.x-access-token-key }}"
          x-access-token-secret: "${{ secrets.x-access-token-secret }}"
          x-consumer-api-key: "${{ secrets.x-consumer-api-key }}"
          x-consumer-api-secret: "${{ secrets.x-consumer-api-secret }}"          
          deno-version: "${{ vars.DENO_VERSION }}"
          action-version: "${{ vars.CICD_SCRIPTS_VERSION }}"

      - name: Create GitHub Release ${{ inputs.dry-run == true && '(Dry Run)' || '' }}
        if: ${{ inputs.dry-run == false }}
        uses: ncipollo/release-action@v1
        with:
          name: "🚀${{ inputs.release-type }} - ${{ needs.get_and_validate_version.outputs.version }}"
          tag: ${{ needs.get_and_validate_version.outputs.version }}
          owner: ${{ vars.ORGANIZATION_NAME }}
          repo: ${{ inputs.project-name }}
          bodyFile: "${{ github.workspace }}/ReleaseNotes/${{ inputs.release-type }}Releases/Release-Notes-${{ needs.get_and_validate_version.outputs.version }}.md"
          artifacts: "${{ github.workspace }}/ReleaseNotes/${{ inputs.release-type }}Releases/Release-Notes-${{ needs.get_and_validate_version.outputs.version }}.md"
          prerelease: ${{ inputs.release-type }} == 'Preview'
          token: ${{ secrets.CICD_TOKEN }}
          
      - name: Close Milestone
        uses: KinsonDigital/Infrastructure/actions/close-milestone@main
        with:
          repo_owner: "${{ vars.ORGANIZATION_NAME }}"
          repo_name: "${{ inputs.project-name }}"
          github-token: "${{ secrets.cicd-pat }}"
          milestone_title: "${{ needs.get_and_validate_version.outputs.version }}"
          deno-version: "${{ vars.DENO_VERSION }}"
          action-version: "${{ vars.CICD_SCRIPTS_VERSION }}"
