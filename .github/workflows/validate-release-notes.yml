name: Validate Release Notes


defaults:
  run:
    shell: pwsh


on:
  workflow_call:
    inputs:
      org-name:
        required: true
        description: The name of GitHub organization
        type: string
      project-name:
        required: true
        description: The name of the C# project to validate
        type: string
      version:
        required: true
        description: The version of the release notes to validate
        type: string
      cicd-scripts-version:
        required: true
        description: The version of the CICD scripts to use
        type: string
    secrets:
      cicd-rest-api:
        description: The CICD REST API token
        required: true
      

jobs:
  build_script_url:
    name: Build Script URL
    uses: KinsonDigital/Infrastructure/.github/workflows/create-script-url.yml@v5.0.0
    with:
      project-name: ${{ inputs.project-name }}
      cicd-scripts-version: ${{ inputs.cicd-scripts-version }}


  validate_release_notes:
    name: Validate Release Notes
    runs-on: ubuntu-latest
    needs: build_script_url
    steps:
      - name: Set Up Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: v1.x

      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Validate Release Notes Exist
        run: |
          $scriptUrl = "${{ needs.build_script_url.outputs.script-url }}/release-notes-exist.ts";
        
          <# Deno Args:
            1. ReleaseType
            2. Version
          #>
          deno run `
            --allow-read `
            "$scriptUrl" `
            "${{ inputs.org-name }}" `
            "${{ inputs.project-name }}" `
            "preview" `
            "${{ inputs.version }}" `
            "${{ secrets.cicd-rest-api }}";

      - name: Validate Release Notes
        run: |
          $scriptUrl = "${{ needs.build_script_url.outputs.script-url }}/validate-release-notes.ts";
        
          <# Deno Args:
            1. RepoName
            2. ReleaseType
            3. Version
            4. Ignore Label List - Comma delimited values
            5. PRLabel
            6. GitHubToken          
          #>
          deno run `
            --allow-read --allow-net `
            "$scriptUrl" `
            "${{ inputs.project-name }}" `
            "preview" `
            "${{ inputs.version }}" `
            "ðŸš€Preview Release" `
            "${{ secrets.cicd-rest-api }}";
